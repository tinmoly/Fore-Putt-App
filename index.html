<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fore!Putt Practice App ‚Äî Version 1.9.1</title>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0b3d2e;color:#fff;margin:0;padding:20px}
    body.flash-green{animation:flashGreen .15s ease-in-out}
    body.flash-red{animation:flashRed .15s ease-in-out}
    @keyframes flashGreen{from{background:#0b3d2e}to{background:#145a43}}
    @keyframes flashRed{from{background:#0b3d2e}to{background:#6b2a2a}}

    .card{background:#145a43;border-radius:14px;padding:20px;max-width:460px;margin:0 auto;box-shadow:0 10px 25px rgba(0,0,0,.3)}
    h1,h3{text-align:center;margin-bottom:10px}

    .distance-row{display:flex;gap:8px;overflow-x:auto;margin-bottom:12px}
    .distance-btn{background:#1c7c5b;border:none;padding:10px 20px;border-radius:999px;font-weight:800;color:#fff;cursor:pointer;white-space:nowrap;font-size:24px}
    .distance-btn.active{background:#2ecc71;color:#000}

    button{width:100%;border:none;border-radius:14px;cursor:pointer;font-weight:800;margin-top:10px}
    .made,.missed{height:96px;font-size:32px}
    .made{background:#2ecc71;color:#000;box-shadow:3px 0 0 #1e9e54,0 3px 0 #1e9e54,0 10px 20px rgba(0,0,0,.35);border-bottom:3px solid #1e9e54;border-right:3px solid #1e9e54}
    .missed{background:#E34234;color:#000;box-shadow:3px 0 0 #b03026,0 3px 0 #b03026,0 10px 20px rgba(0,0,0,.35);border-bottom:3px solid #b03026;border-right:3px solid #b03026}
    button:active{transform:translateY(3px) scale(.97);box-shadow:0 2px 0 rgba(0,0,0,.25)}

    .stats{text-align:center;font-size:18px;margin-top:20px}
    .badge{margin-top:10px;padding:10px;border-radius:10px;text-align:center;background:#0e4f3a}
    .badge.met{background:#1f7a4a}
    .badge.not-met{background:#6b2a2a}

    .history-card{padding:10px;background:#1c7c5b;border-radius:10px;cursor:pointer}
    .history-wrapper{margin-bottom:10px}
    .accordion{display:none;margin-top:8px;padding:10px;background:#0e4f3a;border-radius:10px}
    .subtle{opacity:.75;font-size:14px;margin-left:6px}
  </style>
</head>
<body>
<div class="card">
  <h1 id="distanceTitle">2-Foot Putts</h1>
  <div id="distanceRow" class="distance-row"></div>

  <div style="display:flex;gap:20px;">
    <button class="made" onclick="recordMade()">‚úÖ Made</button>
    <button class="missed" onclick="recordMissed()">‚õî Missed</button>
  </div>

  <div class="stats">
    <p>Made: <span id="made">0</span> | Missed: <span id="missed">0</span></p>
    <p>‚õ≥ Make %: <span id="percent">0</span>%</p>
    <p><span id="streakLabel">Streak</span>: <span id="streak">0</span></p>
  </div>

  <div id="targetBadge" class="badge"></div>

  <button onclick="newSession()" style="background:#0096FF;color:#000;height:48px;font-size:24px;box-shadow:0px 0 0 #0074c7,0 5px 0 #0074c7;">üîÑ New Session</button>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
    <h3 style="margin:0">Session History</h3>
    <select id="historyAction" onchange="handleHistoryAction()" style="background:#1c7c5b;color:#fff;border:none;border-radius:8px;padding:6px 8px;font-weight:700">
      <option value="">Actions</option>
      <option value="export">Export All History</option>
      <option value="delete">Clear All History</option>
    </select>
  </div>
  <div id="history"></div>
</div>

<script>
// ---------- Constants ----------
const DISTANCES = [2,3,4,5,6,7,8,9,10,15,20,30];
const PGA_TOUR_AVG = {2:99,3:96,4:88,5:77,6:66,7:58,8:50,9:45,10:40,15:23,20:15,30:7};

// ---------- State ----------
let currentDistance = 2;
let stats = loadStats();
let streaks = loadStreaks();
let bestStreaks = defaultBestStreaks();
let sessions = loadSessions();

// ---------- Utilities ----------
const $ = id => document.getElementById(id);
let tapLocked = false;
const TAP_DELAY = 300;

function withTapLock(fn){
  if(tapLocked) return;
  tapLocked = true;
  fn();
  setTimeout(function(){ tapLocked = false; }, TAP_DELAY);
}

function haptic(ms){
  if(navigator.vibrate) navigator.vibrate(ms);
}

function flash(cls){
  document.body.classList.add(cls);
  setTimeout(function(){ document.body.classList.remove(cls); }, 150);
}

function getStreakEmojis(v){
  if(v>=10) return 'üî•üî•üî•üî•üî•';
  if(v>=7) return 'üî•üî•üî•üî•';
  if(v>=5) return 'üî•üî•üî•';
  if(v>=3) return 'üî•üî•';
  if(v>=1) return 'üî•';
  return '';
}

// ---------- Persistence ----------
function defaultStats(){
  var o = {};
  DISTANCES.forEach(function(d){ o[d] = { made:0, missed:0 }; });
  return o;
}

function loadStats(){
  return JSON.parse(localStorage.getItem('puttingStats')) || defaultStats();
}

function saveStats(){
  localStorage.setItem('puttingStats', JSON.stringify(stats));
}

function loadStreaks(){
  var s = JSON.parse(localStorage.getItem('puttingStreaks')) || {};
  var o = {};
  DISTANCES.forEach(function(d){ o[d] = s[d] || 0; });
  return o;
}

function saveStreaks(){
  localStorage.setItem('puttingStreaks', JSON.stringify(streaks));
}

function defaultBestStreaks(){
  var o = {};
  DISTANCES.forEach(function(d){ o[d] = 0; });
  return o;
}

function loadSessions(){
  return JSON.parse(localStorage.getItem('puttingSessions')) || [];
}

function saveSessions(){
  localStorage.setItem('puttingSessions', JSON.stringify(sessions));
}

// ---------- UI ----------
function buildDistanceRow(){
  var r = $('distanceRow');
  r.innerHTML = '';
  DISTANCES.forEach(function(d){
    var b = document.createElement('button');
    b.className = 'distance-btn' + (d === currentDistance ? ' active' : '');
    b.textContent = d + "'";
    b.onclick = function(){ setDistance(d); };
    r.appendChild(b);
  });
}

function setDistance(d){
  currentDistance = d;
  streaks[d] = 0;
  saveStreaks();
  $('distanceTitle').textContent = d + '-Foot Putts';
  buildDistanceRow();
  updateStats();
}

function updateStats(){
  var made = stats[currentDistance].made;
  var missed = stats[currentDistance].missed;
  var total = made + missed;
  var pct = total ? Math.round(made / total * 100) : 0;

  $('made').textContent = made;
  $('missed').textContent = missed;
  $('percent').textContent = pct;

  var s = streaks[currentDistance] || 0;
  $('streak').textContent = s;
  $('streakLabel').textContent = (getStreakEmojis(s) + ' Streak').trim();

  var target = PGA_TOUR_AVG[currentDistance];
  var badge = $('targetBadge');
  badge.className = 'badge ' + (pct >= target ? 'met' : 'not-met');
  badge.innerHTML = pct >= target
    ? 'üèÜ Better than PGA Tour Avg!<br>üéØ Target: ' + target + '%'
    : 'üéØ Target: ' + target + '% PGA Tour Avg';
}

// ---------- Actions ----------
function recordMade(){
  withTapLock(function(){
    stats[currentDistance].made++;
    streaks[currentDistance]++;
    if(streaks[currentDistance] > bestStreaks[currentDistance]){
      bestStreaks[currentDistance] = streaks[currentDistance];
    }
    flash('flash-green');
    haptic(20);
    saveStats();
    saveStreaks();
    updateStats();
  });
}

function recordMissed(){
  withTapLock(function(){
    stats[currentDistance].missed++;
    streaks[currentDistance] = 0;
    flash('flash-red');
    haptic([10,40]);
    saveStats();
    saveStreaks();
    updateStats();
  });
}

function newSession(){
  if(!confirm('Start a new session?')) return;

  var totalMade = 0;
  var totalMissed = 0;

  Object.values(stats).forEach(function(d){
    totalMade += d.made;
    totalMissed += d.missed;
  });

  var totalPutts = totalMade + totalMissed;
  var overallPct = totalPutts ? Math.round(totalMade / totalPutts * 100) : 0;

  sessions.push({
    date: new Date().toISOString(),
    stats: JSON.parse(JSON.stringify(stats)),
    bestStreaks: JSON.parse(JSON.stringify(bestStreaks)),
    summary: {
      made: totalMade,
      missed: totalMissed,
      total: totalPutts,
      pct: overallPct
    }
  });

  saveSessions();
  stats = defaultStats();
  streaks = loadStreaks();
  bestStreaks = defaultBestStreaks();
  updateStats();
  renderHistory();
}

function handleHistoryAction(){
  var sel = $('historyAction');
  var v = sel.value;
  sel.value = '';

  if(v === 'delete'){
    if(!confirm('Delete all session history?')) return;
    sessions = [];
    saveSessions();
    renderHistory();
  }

  if(v === 'export'){
    exportHistoryCSV();
  }
}

// ---------- CSV Export ----------
function exportHistoryCSV(){
  if(!sessions.length){
    alert('No session history to export.');
    return;
  }

  var csv = 'Session,Date,Time,Distance,Made,Missed,Total,Make%,PGA Tour Avg %,Delta vs PGA,Streak\n';

  sessions.forEach(function(s, i){
    var d = new Date(s.date);
    var dateStr = d.toLocaleDateString();
    var timeStr = d.toLocaleTimeString();

    DISTANCES.forEach(function(dist){
      var st = s.stats[dist];
      var total = st.made + st.missed;
      if(!total) return;

      var makePct = Math.round(st.made / total * 100);
      var pga = PGA_TOUR_AVG[dist];
      var delta = makePct - pga;

      csv += (i+1) + ',' + dateStr + ',' + timeStr + ',' + dist + ',' +
             st.made + ',' + st.missed + ',' + total + ',' +
             makePct + ',' + pga + ',' + delta + ',' +
             (s.bestStreaks[dist] || 0) + '\n';
    });

    csv += (i+1) + ',' + dateStr + ',' + timeStr + ',SUMMARY,' +
           s.summary.made + ',' + s.summary.missed + ',' +
           s.summary.total + ',' + s.summary.pct + ',,,\n';
  });

  var blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'foreputt_history.csv';
  a.click();
}

// ---------- History ----------
function renderHistory(){
  var h = $('history');
  h.innerHTML = '';

  if(!sessions.length){
    h.innerHTML = '<p style="opacity:.8">No sessions yet.</p>';
    return;
  }

  sessions.slice().reverse().forEach(function(s, i){
    var idx = sessions.length - 1 - i;

    var wrap = document.createElement('div');
    wrap.className = 'history-wrapper';

    var card = document.createElement('div');
    card.className = 'history-card';

    var acc = document.createElement('div');
    acc.className = 'accordion';

    card.innerHTML = '<strong>Session ' + (idx+1) + '</strong><br>' +
      new Date(s.date).toLocaleDateString() + ' ‚Ä¢ ' +
      s.summary.pct + '% (' + s.summary.total + ' putts)';

    card.onclick = function(){
      acc.style.display = acc.style.display === 'block' ? 'none' : 'block';
    };

    DISTANCES.forEach(function(d){
      var st = s.stats[d];
      var tot = st.made + st.missed;
      if(!tot) return;

      var p = Math.round(st.made / tot * 100);
      var star = p >= PGA_TOUR_AVG[d] ? ' ‚≠ê' : '';

      var row = document.createElement('div');
      row.innerHTML = '<strong>' + d + ' ft:</strong> ' +
        st.made + '/' + tot + ' (' + p + '%) ‚Äî PGA ' +
        PGA_TOUR_AVG[d] + '%' + star +
        '<br><span class="subtle">Best streak: ' +
        (s.bestStreaks[d] || 0) + '</span>';

      acc.appendChild(row);
    });

    var del = document.createElement('button');
    del.textContent = 'üóëÔ∏è Delete Session';
    del.style.background = '#E34234';
    del.style.height = '48px';
    del.style.fontSize = '20px';
    del.style.lineHeight = '20px';
    del.style.boxShadow = '0px 0 0 #b03026,0 5px 0 #b03026';

    del.onclick = function(e){
      e.stopPropagation();
      if(!confirm('Delete this session?')) return;
      sessions.splice(idx, 1);
      saveSessions();
      renderHistory();
    };

    acc.appendChild(del);
    wrap.appendChild(card);
    wrap.appendChild(acc);
    h.appendChild(wrap);
  });
}

// ---------- Init ----------
buildDistanceRow();
updateStats();
renderHistory();
</script>
</body>
</html>
